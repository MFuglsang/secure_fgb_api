<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <title>Flatgeobuf proxy test</title>

  <link rel="stylesheet" href="/node_modules/ol/ol.css">
  <style>
    html, body { margin: 0; height: 100%; }
    #map { width: 100%; height: 100%; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- proj4 -->
  <script src="https://cdn.jsdelivr.net/npm/proj4@2/dist/proj4.js"></script>

  <!-- import map MAPPER node-moduler → browser-imports -->
<script type="importmap">
{
  "imports": {
    "rbush": "/node_modules/rbush/index.js",
    "quickselect": "/node_modules/quickselect/index.js",
    "geodesy/latlon-spherical": "/node_modules/geodesy/latlon-spherical.min.js",
    "ol/": "/node_modules/ol/",
    "flatbuffers": "/node_modules/flatbuffers/mjs/flatbuffers.js",
    "slice-source": "/node_modules/slice-source/index.js",
    "@repeaterjs/repeater": "/node_modules/@repeaterjs/repeater/repeater.js"
  },
  "scopes": {
    "/node_modules/slice-source/": {
      "./empty": "/node_modules/slice-source/empty.js",
      "./cancel": "/node_modules/slice-source/cancel.js",
      "./read": "/node_modules/slice-source/read.js",
      "./slice": "/node_modules/slice-source/slice.js"
    }
  }
}
</script>

  <script type="module">
    import Map from "/node_modules/ol/Map.js";
    import View from "/node_modules/ol/View.js";

    import TileLayer from "/node_modules/ol/layer/Tile.js";
    import VectorLayer from "/node_modules/ol/layer/Vector.js";

    import VectorSource from "/node_modules/ol/source/Vector.js";
    import WMTS, {optionsFromCapabilities} from "/node_modules/ol/source/WMTS.js";

    import WMTSCapabilities from "/node_modules/ol/format/WMTSCapabilities.js";
    import {Style, Fill, Stroke} from "/node_modules/ol/style.js";
    import {bbox as bboxStrategy} from "/node_modules/ol/loadingstrategy.js";

    import {register} from "/node_modules/ol/proj/proj4.js";
    import {get as getProjection} from "/node_modules/ol/proj.js";

    // FLATGEOBUF
    import { createLoader, FeatureCollection } from "/node_modules/flatgeobuf/lib/mjs/ol.js";

    // ----- EPSG:25832 -----
    proj4.defs("EPSG:25832","+proj=utm +zone=32 +ellps=GRS80 +units=m +no_defs");
    register(proj4);
    const epsg25832 = getProjection("EPSG:25832");

    const dkCenter = [600000, 6200000];

    // ----- VECTOR med FlatGeobuf -----
    const fc = new FeatureCollection();
    const vectorSource = new VectorSource({
      strategy: bboxStrategy
    });
    
    vectorSource.setLoader(
      createLoader(fc, vectorSource, "/fgb/lokalplan_vedtaget.fgb", bboxStrategy)
    );

    const vectorLayer = new VectorLayer({
      source: vectorSource,
      style: new Style({
        stroke: new Stroke({
          color: 'rgba(0, 100, 255, 1)',
          width: 2
        }),
        fill: new Fill({
          color: 'rgba(0, 100, 255, 0.3)'
        })
      }),
      // Vis kun ved zoom niveau under 1:100.000
      // I EPSG:25832 svarer det cirka til zoom 10 eller højere
      minZoom: 14
    });

    // ----- MAP -----
    const map = new Map({
      target: "map",
      layers: [vectorLayer],
      view: new View({
        projection: epsg25832,
        center: dkCenter,
        zoom: 7
      })
    });

    // ----- WMTS Skærmkort -----
    // Fetch token from API to avoid exposing it in frontend code
    fetch('/api/config')
      .then(r => r.json())
      .then(config => {
        const TOKEN = config.dataforsyningen_token;
        if (!TOKEN) {
          console.warn('Dataforsyningen token not configured');
          return;
        }

        const capabilitiesUrl =
          "https://api.dataforsyningen.dk/topo_skaermkort_wmts_DAF" +
          "?token=" + encodeURIComponent(TOKEN) +
          "&SERVICE=WMTS&REQUEST=GetCapabilities";

    fetch(capabilitiesUrl)
      .then(r => r.text())
      .then(text => {
        const parser = new WMTSCapabilities();
        const caps = parser.read(text);

        const options = optionsFromCapabilities(caps, {
          layer: "topo_skaermkort",
          matrixSet: "View1"
        });

        const skaermkortLayer = new TileLayer({
          source: new WMTS(options)
        });

        map.getLayers().insertAt(0, skaermkortLayer);
      })
      .catch(err => console.error('Failed to load basemap:', err));
    })
    .catch(err => console.error('Failed to fetch config:', err));
  </script>
</body>
</html>
