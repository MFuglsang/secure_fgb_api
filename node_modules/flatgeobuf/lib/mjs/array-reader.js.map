{"version":3,"sources":["../../../../src/ts/array-reader.ts"],"sourcesContent":["import * as flatbuffers from 'flatbuffers';\nimport { magicbytes, SIZE_PREFIX_LEN } from './constants.js';\nimport { Feature } from './flat-geobuf/feature.js';\nimport type { HeaderMeta } from './header-meta.js';\nimport { fromByteBuffer } from './header-meta.js';\nimport { calcTreeSize, type Rect, streamSearch } from './packedrtree.js';\n\ninterface FeatureWithId {\n    id: number;\n    feature: Feature;\n}\n\nexport class ArrayReader {\n    private bytes: Uint8Array;\n    public header: HeaderMeta;\n    private headerLength: number;\n    private indexLength: number;\n\n    constructor(bytes: Uint8Array, header: HeaderMeta, headerLength: number, indexLength: number) {\n        this.bytes = bytes;\n        this.header = header;\n        this.headerLength = headerLength;\n        this.indexLength = indexLength;\n    }\n\n    static open(bytes: Uint8Array): ArrayReader {\n        if (!bytes.subarray(0, 3).every((v, i) => magicbytes[i] === v)) {\n            throw new Error('Not a FlatGeobuf file');\n        }\n\n        const headerLength = new DataView(bytes.buffer).getUint32(8, true);\n        const HEADER_MAX_BUFFER_SIZE = 1048576 * 10;\n        if (headerLength > HEADER_MAX_BUFFER_SIZE || headerLength < 8) {\n            throw new Error('Invalid header size');\n        }\n\n        const headerBytes = bytes.subarray(12, 12 + headerLength);\n        const bb = new flatbuffers.ByteBuffer(headerBytes);\n        const header = fromByteBuffer(bb);\n\n        const indexLength = calcTreeSize(header.featuresCount, header.indexNodeSize);\n\n        return new ArrayReader(bytes, header, headerLength, indexLength);\n    }\n\n    async *selectBbox(rect: Rect): AsyncGenerator<FeatureWithId, void, unknown> {\n        const lengthBeforeTree = this.lengthBeforeTree();\n\n        const readNode = async (offsetIntoTree: number, size: number): Promise<ArrayBuffer> => {\n            const start = lengthBeforeTree + offsetIntoTree;\n            return this.bytes.slice(start, start + size).buffer;\n        };\n\n        for await (const searchResult of streamSearch(\n            this.header.featuresCount,\n            this.header.indexNodeSize,\n            rect,\n            readNode,\n        )) {\n            const [featureOffset, featureIdx] = searchResult;\n            const feature = this.readFeature(featureOffset);\n\n            yield { id: featureIdx, feature };\n        }\n    }\n\n    private lengthBeforeTree(): number {\n        return magicbytes.length + SIZE_PREFIX_LEN + this.headerLength;\n    }\n\n    private lengthBeforeFeatures(): number {\n        return this.lengthBeforeTree() + this.indexLength;\n    }\n\n    private readFeature(featureOffset: number): Feature {\n        const offset = featureOffset + this.lengthBeforeFeatures();\n\n        const featureLength = new DataView(this.bytes.buffer).getUint32(offset, true);\n        const featureBytes = this.bytes.subarray(offset + 4, offset + 4 + featureLength);\n\n        const bytesAligned = new Uint8Array(featureLength + SIZE_PREFIX_LEN);\n        bytesAligned.set(featureBytes, SIZE_PREFIX_LEN);\n\n        const bb = new flatbuffers.ByteBuffer(bytesAligned);\n        bb.setPosition(SIZE_PREFIX_LEN);\n        return Feature.getRootAsFeature(bb);\n    }\n}\n"],"names":["flatbuffers","magicbytes","SIZE_PREFIX_LEN","Feature","fromByteBuffer","calcTreeSize","streamSearch","ArrayReader","bytes","header","headerLength","indexLength","open","subarray","every","v","i","Error","DataView","buffer","getUint32","headerBytes","ByteBuffer","featuresCount","indexNodeSize","selectBbox","rect","lengthBeforeTree","readNode","offsetIntoTree","size","start","slice","searchResult","featureOffset","featureIdx","feature","readFeature","id","length","lengthBeforeFeatures","offset","featureLength","featureBytes","bytesAligned","Uint8Array","set","bb","setPosition","getRootAsFeature"],"mappings":"AAAA,UAAYA,MAAiB,aAAc,AAC3C,QAASC,cAAAA,CAAU,CAAEC,mBAAAA,CAAe,KAAQ,gBAAiB,AAC7D,QAASC,WAAAA,CAAO,KAAQ,0BAA2B,AAEnD,QAASC,kBAAAA,CAAc,KAAQ,kBAAmB,AAClD,QAASC,gBAAAA,CAAY,CAAaC,gBAAAA,CAAY,KAAQ,kBAAmB,AAOzE,QAAO,MAAMC,YACT,AAAQC,KAAkB,AAC1B,CAAOC,MAAmB,AAC1B,CAAQC,YAAqB,AAC7B,CAAQC,WAAoB,AAE5B,aAAYH,CAAiB,CAAEC,CAAkB,CAAEC,CAAoB,CAAEC,CAAmB,CAAE,CAC1F,IAAI,CAACH,KAAK,CAAGA,EACb,IAAI,CAACC,MAAM,CAAGA,EACd,IAAI,CAACC,YAAY,CAAGA,EACpB,IAAI,CAACC,WAAW,CAAGA,CACvB,CAEA,OAAOC,KAAKJ,CAAiB,CAAe,CACxC,GAAI,CAACA,EAAMK,QAAQ,CAAC,EAAG,GAAGC,KAAK,CAAC,CAACC,EAAGC,IAAMf,CAAU,CAACe,EAAE,GAAKD,GACxD,MAAM,AAAIE,MAAM,yBAGpB,IAAMP,EAAe,IAAIQ,SAASV,EAAMW,MAAM,EAAEC,SAAS,CAAC,EAAG,CAAA,GAE7D,GAAIV,EAD2B,UACcA,EAAe,EACxD,MAAM,AAAIO,MAAM,uBAGpB,IAAMI,EAAcb,EAAMK,QAAQ,CAAC,GAAI,GAAKH,GAEtCD,EAASL,EADJ,IAAIJ,EAAYsB,UAAU,CAACD,IAGhCV,EAAcN,EAAaI,EAAOc,aAAa,CAAEd,EAAOe,aAAa,EAE3E,OAAO,IAAIjB,YAAYC,EAAOC,EAAQC,EAAcC,EACxD,CAEA,OAAOc,WAAWC,CAAU,CAAgD,CACxE,IAAMC,EAAmB,IAAI,CAACA,gBAAgB,GAExCC,EAAW,MAAOC,EAAwBC,KAC5C,IAAMC,EAAQJ,EAAmBE,EACjC,OAAO,IAAI,CAACrB,KAAK,CAACwB,KAAK,CAACD,EAAOA,EAAQD,GAAMX,MAAM,AACvD,EAEA,UAAW,IAAMc,KAAgB3B,EAC7B,IAAI,CAACG,MAAM,CAACc,aAAa,CACzB,IAAI,CAACd,MAAM,CAACe,aAAa,CACzBE,EACAE,GACD,CACC,GAAM,CAACM,EAAeC,EAAW,CAAGF,EAC9BG,EAAU,IAAI,CAACC,WAAW,CAACH,EAEjC,MAAM,CAAEI,GAAIH,EAAYC,QAAAA,CAAQ,CACpC,CACJ,CAEA,AAAQT,kBAA2B,CAC/B,OAAO1B,EAAWsC,MAAM,CAAGrC,EAAkB,IAAI,CAACQ,YAAY,AAClE,CAEA,AAAQ8B,sBAA+B,CACnC,OAAO,IAAI,CAACb,gBAAgB,GAAK,IAAI,CAAChB,WAAW,AACrD,CAEA,AAAQ0B,YAAYH,CAAqB,CAAW,CAChD,IAAMO,EAASP,EAAgB,IAAI,CAACM,oBAAoB,GAElDE,EAAgB,IAAIxB,SAAS,IAAI,CAACV,KAAK,CAACW,MAAM,EAAEC,SAAS,CAACqB,EAAQ,CAAA,GAClEE,EAAe,IAAI,CAACnC,KAAK,CAACK,QAAQ,CAAC4B,EAAS,EAAGA,EAAS,EAAIC,GAE5DE,EAAe,IAAIC,WAAWH,EAAgBxC,GACpD0C,EAAaE,GAAG,CAACH,EAAczC,GAE/B,IAAM6C,EAAK,IAAI/C,EAAYsB,UAAU,CAACsB,GAEtC,OADAG,EAAGC,WAAW,CAAC9C,GACRC,EAAQ8C,gBAAgB,CAACF,EACpC,CACJ"}