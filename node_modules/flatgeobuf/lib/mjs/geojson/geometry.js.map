{"version":3,"sources":["../../../../../src/ts/geojson/geometry.ts"],"sourcesContent":["import type {\n    Geometry as GeoJsonGeometry,\n    GeometryCollection,\n    LineString,\n    MultiLineString,\n    MultiPoint,\n    MultiPolygon,\n    Point,\n    Polygon,\n} from 'geojson';\nimport type { Geometry } from '../flat-geobuf/geometry.js';\nimport { GeometryType } from '../flat-geobuf/geometry-type.js';\n\nimport { flat, type IParsedGeometry, pairFlatCoordinates, toGeometryType } from '../generic/geometry.js';\n\nexport interface IGeoJsonGeometry {\n    type: string;\n    coordinates: number[] | number[][] | number[][][] | number[][][][];\n    geometries?: IGeoJsonGeometry[];\n}\n\nexport function parseGeometry(\n    geometry: Point | MultiPoint | LineString | MultiLineString | Polygon | MultiPolygon,\n): IParsedGeometry {\n    const cs = geometry.coordinates;\n    const xy: number[] = [];\n    const z: number[] = [];\n    let ends: number[] | undefined;\n    let parts: IParsedGeometry[] | undefined;\n    const type: GeometryType = toGeometryType(geometry.type);\n    let end = 0;\n    switch (geometry.type) {\n        case 'Point':\n            flat(cs as number[], xy, z);\n            break;\n        case 'MultiPoint':\n        case 'LineString':\n            flat(cs as number[][], xy, z);\n            break;\n        case 'MultiLineString':\n        case 'Polygon': {\n            const css = cs as number[][];\n            flat(css, xy, z);\n            if (css.length > 1) ends = css.map((c) => (end += c.length));\n            break;\n        }\n        case 'MultiPolygon': {\n            const csss = cs as number[][][][];\n            const geometries = csss.map((coordinates) => ({\n                type: 'Polygon',\n                coordinates,\n            })) as Polygon[];\n            parts = geometries.map(parseGeometry);\n            break;\n        }\n    }\n    return {\n        xy,\n        z: z.length > 0 ? z : undefined,\n        ends,\n        type,\n        parts,\n    } as IParsedGeometry;\n}\n\nexport function parseGC(geometry: GeometryCollection): IParsedGeometry {\n    const type: GeometryType = toGeometryType(geometry.type);\n    const parts: IParsedGeometry[] = [];\n    for (let i = 0; i < geometry.geometries.length; i++) {\n        const g = geometry.geometries[i];\n        if (g.type === 'GeometryCollection') parts.push(parseGC(g));\n        else parts.push(parseGeometry(g));\n    }\n    return {\n        type,\n        parts,\n    } as IParsedGeometry;\n}\n\nfunction extractParts(xy: Float64Array, z: Float64Array, ends: Uint32Array) {\n    if (!ends || ends.length === 0) return [pairFlatCoordinates(xy, z)];\n    let s = 0;\n    const xySlices = Array.from(ends).map((e) => xy.slice(s, (s = e << 1)));\n    let zSlices: Float64Array[];\n    if (z) {\n        s = 0;\n        zSlices = Array.from(ends).map((e) => z.slice(s, (s = e)));\n    }\n    return xySlices.map((xy, i) => pairFlatCoordinates(xy, zSlices ? zSlices[i] : undefined));\n}\n\nfunction toGeoJsonCoordinates(geometry: Geometry, type: GeometryType) {\n    const xy = geometry.xyArray() as Float64Array;\n    const z = geometry.zArray() as Float64Array;\n    switch (type) {\n        case GeometryType.Point: {\n            const a = Array.from(xy);\n            if (z) a.push(z[0]);\n            return a;\n        }\n        case GeometryType.MultiPoint:\n        case GeometryType.LineString:\n            return pairFlatCoordinates(xy, z);\n        case GeometryType.MultiLineString:\n            return extractParts(xy, z, geometry.endsArray() as Uint32Array);\n        case GeometryType.Polygon:\n            return extractParts(xy, z, geometry.endsArray() as Uint32Array);\n    }\n}\n\nexport function fromGeometry(geometry: Geometry, headerType: GeometryType): GeoJsonGeometry {\n    let type = headerType;\n    if (type === GeometryType.Unknown) {\n        type = geometry.type();\n    }\n    if (type === GeometryType.GeometryCollection) {\n        const geometries: GeoJsonGeometry[] = [];\n        for (let i = 0; i < geometry.partsLength(); i++) {\n            const part = geometry.parts(i) as Geometry;\n            const partType = part.type() as GeometryType;\n            geometries.push(fromGeometry(part, partType));\n        }\n        return {\n            type: GeometryType[type],\n            geometries,\n        } as GeoJsonGeometry;\n    }\n    if (type === GeometryType.MultiPolygon) {\n        const geometries: GeoJsonGeometry[] = [];\n        for (let i = 0; i < geometry.partsLength(); i++)\n            geometries.push(fromGeometry(geometry.parts(i) as Geometry, GeometryType.Polygon));\n        return {\n            type: GeometryType[type],\n            coordinates: geometries.map((g) => (g as Polygon).coordinates),\n        } as GeoJsonGeometry;\n    }\n    const coordinates = toGeoJsonCoordinates(geometry, type);\n    return {\n        type: GeometryType[type],\n        coordinates,\n    } as GeoJsonGeometry;\n}\n"],"names":["GeometryType","flat","pairFlatCoordinates","toGeometryType","parseGeometry","geometry","ends","parts","cs","coordinates","xy","z","type","end","css","length","map","c","geometries","csss","undefined","parseGC","i","g","push","fromGeometry","headerType","Unknown","GeometryCollection","partsLength","part","partType","MultiPolygon","Polygon","toGeoJsonCoordinates","xyArray","zArray","Point","a","Array","from","MultiPoint","LineString","MultiLineString","extractParts","zSlices","s","xySlices","e","slice","endsArray"],"mappings":"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"}