{"version":3,"sources":["../../../../src/ts/dumptree.ts"],"sourcesContent":["// tool to dump spatial index tree\n// run with fx. node --loader ts-node/esm.mjs src/ts/dumptree.ts\n\nimport { readFileSync, writeFileSync } from 'node:fs';\nimport flatbuffers from 'flatbuffers';\nimport Envelope from 'jsts/org/locationtech/jts/geom/Envelope.js';\nimport GeometryFactory from 'jsts/org/locationtech/jts/geom/GeometryFactory.js';\nimport GeoJSONWriter from 'jsts/org/locationtech/jts/io/GeoJSONWriter.js';\n\nimport { magicbytes, SIZE_PREFIX_LEN } from './constants.js';\nimport { fromByteBuffer } from './header-meta.js';\nimport { calcTreeSize, generateLevelBounds } from './packedrtree.js';\n\nconst buffer = readFileSync('./test/data/tiger_roads.fgb');\nconst bytes = new Uint8Array(buffer);\n\nif (!bytes.subarray(0, 3).every((v, i) => magicbytes[i] === v)) throw new Error('Not a FlatGeobuf file');\n\nconst bb = new flatbuffers.ByteBuffer(bytes);\nconst headerLength = bb.readUint32(magicbytes.length);\nbb.setPosition(magicbytes.length + SIZE_PREFIX_LEN);\n\nconst headerMeta = fromByteBuffer(bb);\n\nif (headerMeta.indexNodeSize === 0) throw new Error('No index found');\n\nlet offset = magicbytes.length + SIZE_PREFIX_LEN + headerLength;\nconst numItems = headerMeta.featuresCount;\nconst nodeSize = headerMeta.indexNodeSize;\nconst envelope = headerMeta.envelope;\n\nconsole.log(`Number of items in tree: ${numItems}`);\nconsole.log(`Envelope: ${envelope}`);\nconsole.log(`Tree node index size: ${nodeSize}`);\nconsole.log(`Offset: ${offset}`);\n\nconst treeSize = calcTreeSize(numItems, nodeSize);\nconst levelBounds = generateLevelBounds(numItems, nodeSize).reverse();\n\nconsole.log('Level bounds:');\nfor (const levelBound of levelBounds) console.log(`  ${levelBound}`);\n\nconsole.log(`Size: ${treeSize}`);\n\nconst items: number[][] = [];\n\nfunction readNode(level: number) {\n    const minx = buffer.readDoubleLE(offset + 0);\n    const miny = buffer.readDoubleLE(offset + 8);\n    const maxx = buffer.readDoubleLE(offset + 16);\n    const maxy = buffer.readDoubleLE(offset + 24);\n    items.push([level, minx, miny, maxx, maxy]);\n    offset += 40;\n}\n\nlet level = 0;\nfor (const levelBound of levelBounds) {\n    for (let i = levelBound[0]; i < levelBound[1]; i++) readNode(level);\n    level++;\n}\n\nconst writer = new GeoJSONWriter();\nconst factory = new GeometryFactory();\n\nconst geojsonfeatures = items.map((i) => {\n    const geometry = factory.toGeometry(new Envelope(i[1], i[3], i[2], i[4]));\n    return {\n        type: 'Feature',\n        geometry: writer.write(geometry),\n        properties: {\n            level: i[0],\n        },\n    };\n});\n\nconst geojson = {\n    type: 'FeatureCollection',\n    features: geojsonfeatures,\n};\n\nwriteFileSync('out.geojson', JSON.stringify(geojson));\n"],"names":["readFileSync","writeFileSync","flatbuffers","Envelope","GeometryFactory","GeoJSONWriter","magicbytes","SIZE_PREFIX_LEN","fromByteBuffer","calcTreeSize","generateLevelBounds","buffer","bytes","Uint8Array","subarray","every","v","i","Error","bb","ByteBuffer","headerLength","readUint32","length","setPosition","headerMeta","indexNodeSize","offset","numItems","featuresCount","nodeSize","envelope","levelBounds","reverse","levelBound","items","level","readNode","minx","readDoubleLE","miny","maxx","maxy","push","writer","factory","JSON","stringify","type","features","map","geometry","toGeometry","write","properties"],"mappings":"AAGA,OAASA,gBAAAA,CAAY,CAAEC,iBAAAA,CAAa,KAAQ,SAAU,AACtD,QAAOC,MAAiB,aAAc,AACtC,QAAOC,MAAc,4CAA6C,AAClE,QAAOC,MAAqB,mDAAoD,AAChF,QAAOC,MAAmB,+CAAgD,AAE1E,QAASC,cAAAA,CAAU,CAAEC,mBAAAA,CAAe,KAAQ,gBAAiB,AAC7D,QAASC,kBAAAA,CAAc,KAAQ,kBAAmB,AAClD,QAASC,gBAAAA,CAAY,CAAEC,uBAAAA,CAAmB,KAAQ,kBAAmB,CAErE,IAAMC,EAASX,EAAa,+BACtBY,EAAQ,IAAIC,WAAWF,GAE7B,GAAI,CAACC,EAAME,QAAQ,CAAC,EAAG,GAAGC,KAAK,CAAC,CAACC,EAAGC,IAAMX,CAAU,CAACW,EAAE,GAAKD,GAAI,MAAM,AAAIE,MAAM,yBAEhF,IAAMC,EAAK,IAAIjB,EAAYkB,UAAU,CAACR,GAChCS,EAAeF,EAAGG,UAAU,CAAChB,EAAWiB,MAAM,EACpDJ,EAAGK,WAAW,CAAClB,EAAWiB,MAAM,CAAGhB,GAEnC,IAAMkB,EAAajB,EAAeW,GAElC,GAAIM,AAA6B,IAA7BA,EAAWC,aAAa,CAAQ,MAAM,AAAIR,MAAM,kBAEpD,IAAIS,EAASrB,EAAWiB,MAAM,CAAGhB,EAAkBc,EAC7CO,EAAWH,EAAWI,aAAa,CACnCC,EAAWL,EAAWC,aAAa,AACxBD,CAAAA,EAAWM,QAAQ,CAOnBtB,EAAamB,EAAUE,GACxC,IAAME,EAActB,EAAoBkB,EAAUE,GAAUG,OAAO,GAGnE,IAAK,IAAMC,KAAcF,GAIzB,IAAMG,EAAoB,EAAE,CAWxBC,EAAQ,EACZ,IAAK,IAAMF,KAAcF,EAAa,CAClC,IAAK,IAAIf,EAAIiB,CAAU,CAAC,EAAE,CAAEjB,EAAIiB,CAAU,CAAC,EAAE,CAAEjB,IAAKoB,KAXtCD,EAW+CA,EAV7D,IAAME,EAAO3B,EAAO4B,YAAY,CAACZ,EAAS,GACpCa,EAAO7B,EAAO4B,YAAY,CAACZ,EAAS,GACpCc,EAAO9B,EAAO4B,YAAY,CAACZ,EAAS,IACpCe,EAAO/B,EAAO4B,YAAY,CAACZ,EAAS,IAC1CQ,EAAMQ,IAAI,CAAC,CAACP,EAAOE,EAAME,EAAMC,EAAMC,EAAK,EAC1Cf,GAAU,EAKwD,CAClES,GACJ,CAEA,IAAMQ,EAAS,IAAIvC,EACbwC,EAAU,IAAIzC,EAkBpBH,EAAc,cAAe6C,KAAKC,SAAS,CAL3B,CACZC,KAAM,oBACNC,SAboBd,EAAMe,GAAG,CAAC,AAACjC,IAC/B,IAAMkC,EAAWN,EAAQO,UAAU,CAAC,IAAIjD,EAASc,CAAC,CAAC,EAAE,CAAEA,CAAC,CAAC,EAAE,CAAEA,CAAC,CAAC,EAAE,CAAEA,CAAC,CAAC,EAAE,GACvE,MAAO,CACH+B,KAAM,UACNG,SAAUP,EAAOS,KAAK,CAACF,GACvBG,WAAY,CACRlB,MAAOnB,CAAC,CAAC,EAAE,AACf,CACJ,CACJ,EAKA"}